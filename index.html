<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Dr. HealBot - Your Virtual Medical Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@48,400,1,0" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Poppins", sans-serif;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .chatbot-toggler {
      position: fixed;
      bottom: 30px;
      right: 35px;
      outline: none;
      border: none;
      height: 55px;
      width: 55px;
      display: flex;
      cursor: pointer;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: #724ae8;
      z-index: 9999;
      transition: all 0.3s ease;
      box-shadow: 0 8px 20px rgba(114, 74, 232, 0.4);
    }

    .chatbot-toggler:hover {
      transform: scale(1.1);
    }

    body.show-chatbot .chatbot-toggler {
      transform: rotate(90deg);
    }

    .chatbot-toggler span {
      color: #fff;
      position: absolute;
      font-size: 28px;
      transition: opacity 0.3s;
    }

    .chatbot-toggler span:last-child {
      opacity: 0;
    }

    body.show-chatbot .chatbot-toggler span:first-child {
      opacity: 0;
    }

    body.show-chatbot .chatbot-toggler span:last-child {
      opacity: 1;
    }

    .chatbot {
      position: fixed;
      right: 35px;
      bottom: 100px;
      width: 420px;
      height: 600px;
      background: #fff;
      border-radius: 15px;
      overflow: hidden;
      opacity: 0;
      pointer-events: none;
      transform: scale(0.5) translateY(20px);
      transform-origin: bottom right;
      z-index: 9998;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
    }

    body.show-chatbot .chatbot {
      opacity: 1;
      pointer-events: auto;
      transform: scale(1) translateY(0);
    }

    .chatbot header {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: #fff;
      background: linear-gradient(135deg, #724ae8, #8b5cf6);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      flex-shrink: 0;
    }

    .chatbot header h2 {
      font-size: 1.2rem;
      font-weight: 600;
    }

    .header-btns {
      display: flex;
      gap: 8px;
    }

    .header-btns span {
      cursor: pointer;
      font-size: 22px;
      padding: 4px;
      border-radius: 50%;
      transition: background 0.2s;
    }

    .header-btns span:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .user-info-bar {
      background: rgba(114, 74, 232, 0.1);
      padding: 8px 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
      color: #724ae8;
      border-bottom: 1px solid #eee;
      flex-shrink: 0;
    }

    .user-info-bar .badge {
      background: #4caf50;
      color: #fff;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.7rem;
    }

    .chatbox {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: #f8f9fa;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .chatbox::-webkit-scrollbar {
      width: 6px;
    }

    .chatbox::-webkit-scrollbar-thumb {
      background: #ccc;
      border-radius: 3px;
    }

    .chat {
      display: flex;
      align-items: flex-end;
      gap: 8px;
    }

    .chat.outgoing {
      justify-content: flex-end;
    }

    .chat .bot-icon {
      width: 32px;
      height: 32px;
      background: #724ae8;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 18px;
      flex-shrink: 0;
    }

    .chat p {
      padding: 12px 16px;
      border-radius: 16px;
      max-width: 80%;
      font-size: 0.9rem;
      line-height: 1.5;
      white-space: pre-wrap;
    }

    .chat.incoming p {
      background: #fff;
      color: #333;
      border-bottom-left-radius: 4px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .chat.outgoing p {
      background: #724ae8;
      color: #fff;
      border-bottom-right-radius: 4px;
    }

    .chat p.error {
      background: #fee;
      color: #c00;
    }

    .chat p.thinking {
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      50% {
        opacity: 0.5;
      }
    }

    .chat-input {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      padding: 12px 16px;
      background: #fff;
      border-top: 1px solid #eee;
      flex-shrink: 0;
    }

    .chat-input textarea {
      flex: 1;
      border: 1px solid #ddd;
      border-radius: 20px;
      padding: 10px 16px;
      font-size: 0.9rem;
      resize: none;
      max-height: 100px;
      min-height: 42px;
      outline: none;
      transition: border-color 0.2s;
    }

    .chat-input textarea:focus {
      border-color: #724ae8;
    }

    .chat-input button {
      width: 42px;
      height: 42px;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .voice-btn {
      background: #f0f0f0;
      color: #724ae8;
    }

    .voice-btn:hover {
      background: #e0e0e0;
    }

    .voice-btn.recording {
      background: #e74c3c;
      color: #fff;
      animation: pulse-rec 1s infinite;
    }

    @keyframes pulse-rec {
      50% {
        transform: scale(1.1);
      }
    }

    .send-btn {
      background: #724ae8;
      color: #fff;
    }

    .send-btn:hover {
      background: #5f3dc4;
    }

    .send-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .speaking-indicator {
      position: absolute;
      bottom: 75px;
      right: 50%;
      transform: translateX(50%);
      background: #4caf50;
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.85rem;
      display: none;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
      z-index: 10;
    }

    .speaking-indicator.active {
      display: flex;
    }

    .speaking-indicator .pulse-dot {
      width: 8px;
      height: 8px;
      background: white;
      border-radius: 50%;
      animation: pulse-dot 1.5s infinite;
    }

    @keyframes pulse-dot {
      50% {
        opacity: 0.3;
        transform: scale(0.8);
      }
    }

    .modal-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      backdrop-filter: blur(4px);
    }

    .modal-overlay.hidden {
      display: none;
    }

    .modal {
      background: #fff;
      padding: 24px;
      border-radius: 16px;
      width: 90%;
      max-width: 340px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal h3 {
      color: #724ae8;
      margin-bottom: 8px;
      font-size: 1.3rem;
    }

    .modal p {
      color: #666;
      font-size: 0.9rem;
      margin-bottom: 16px;
    }

    .modal input {
      width: 100%;
      padding: 12px;
      border: 2px solid #eee;
      border-radius: 10px;
      font-size: 1rem;
      margin-bottom: 16px;
      outline: none;
      transition: border-color 0.2s;
    }

    .modal input:focus {
      border-color: #724ae8;
    }

    .modal-btns {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .modal-btn {
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .modal-btn.primary {
      background: #724ae8;
      color: #fff;
    }

    .modal-btn.primary:hover {
      background: #5f3dc4;
    }

    .modal-btn.secondary {
      background: #f0f0f0;
      color: #333;
    }

    .modal-btn.secondary:hover {
      background: #e0e0e0;
    }

    .modal-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    @media (max-width: 500px) {
      .chatbot {
        right: 0;
        bottom: 0;
        width: 100%;
        height: 100%;
        border-radius: 0;
      }

      .chatbot-toggler {
        bottom: 20px;
        right: 20px;
      }
    }
  </style>
</head>

<body>
  <button class="chatbot-toggler" id="toggler">
    <span class="material-symbols-rounded">medical_services</span>
    <span class="material-symbols-outlined">close</span>
  </button>

  <div class="chatbot" id="chatbot">
    <header>
      <h2>ðŸ©º Dr. HealBot</h2>
      <div class="header-btns">
        <span class="material-symbols-outlined" id="summary-btn" title="View Summary">summarize</span>
        <span class="material-symbols-outlined" id="new-session-btn" title="New Session">refresh</span>
        <span class="material-symbols-outlined" id="close-btn" title="Close">close</span>
      </div>
    </header>

    <div class="user-info-bar" id="user-bar">
      <span class="material-symbols-outlined" style="font-size:18px">person</span>
      <span id="user-name">Guest</span>
    </div>

    <ul class="chatbox" id="chatbox"></ul>

    <div class="speaking-indicator" id="speaking-indicator">
      <div class="pulse-dot"></div>
      <span>Speaking...</span>
    </div>

    <div class="chat-input">
      <button class="voice-btn" id="voice-btn" title="Voice input">
        <span class="material-symbols-rounded">mic</span>
      </button>
      <textarea id="message-input" placeholder="Type your message..." rows="1"></textarea>
      <button class="send-btn" id="send-btn" title="Send">
        <span class="material-symbols-rounded">send</span>
      </button>
    </div>

    <div class="modal-overlay" id="modal">
      <div class="modal">
        <h3>Welcome to Dr. HealBot!</h3>
        <p>Please enter your name to start or continue your consultation:</p>
        <input type="text" id="name-input" placeholder="Your name..." />
        <div class="modal-btns">
          <button class="modal-btn primary" id="start-btn">Start Consultation</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Auto-detect API URL: use current origin for deployed version, empty for local
    const API = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
      ? ''
      : window.location.origin;

    // Elements
    const toggler = document.getElementById('toggler');
    const chatbot = document.getElementById('chatbot');
    const closeBtn = document.getElementById('close-btn');
    const newSessionBtn = document.getElementById('new-session-btn');
    const summaryBtn = document.getElementById('summary-btn');
    const chatbox = document.getElementById('chatbox');
    const input = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const voiceBtn = document.getElementById('voice-btn');
    const modal = document.getElementById('modal');
    const nameInput = document.getElementById('name-input');
    const startBtn = document.getElementById('start-btn');
    const userBar = document.getElementById('user-bar');
    const userNameEl = document.getElementById('user-name');
    const speakingIndicator = document.getElementById('speaking-indicator');

    // State
    let userId = null;
    let userName = null;
    let chatHistory = [];
    let recording = false;
    let mediaRecorder = null;
    let currentSpeech = null; // Track current speech synthesis
    let recognition = null; // Web Speech Recognition

    // Initialize Web Speech API for better STT
    const initSpeechRecognition = () => {
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'en-US';

        recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          input.value = transcript;
          recording = false;
          voiceBtn.classList.remove('recording');
          // Auto-send after recognition
          setTimeout(() => handleSend(), 300);
        };

        recognition.onerror = (event) => {
          console.error('Speech recognition error:', event.error);
          recording = false;
          voiceBtn.classList.remove('recording');
          if (event.error !== 'no-speech') {
            alert('Speech recognition error: ' + event.error);
          }
        };

        recognition.onend = () => {
          recording = false;
          voiceBtn.classList.remove('recording');
        };
      }
    };

    // Stop current speech
    const stopSpeaking = () => {
      if (currentSpeech) {
        currentSpeech.pause();
        currentSpeech.currentTime = 0;
        currentSpeech = null;
        speakingIndicator.classList.remove('active');
      }

      // Also stop Web Speech API synthesis
      if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
      }
    };

    // Text-to-speech with Web Speech API (fallback to server TTS)
    const speak = async (text) => {
      stopSpeaking(); // Stop any current speech

      // Try Web Speech API first (works offline and is more reliable)
      if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.rate = 0.9;
        utterance.pitch = 1;
        utterance.volume = 1;

        utterance.onstart = () => {
          speakingIndicator.classList.add('active');
        };

        utterance.onend = () => {
          speakingIndicator.classList.remove('active');
          currentSpeech = null;
        };

        utterance.onerror = () => {
          speakingIndicator.classList.remove('active');
          currentSpeech = null;
        };

        window.speechSynthesis.speak(utterance);
        currentSpeech = { pause: () => window.speechSynthesis.cancel() };
        return;
      }

      // Fallback to server TTS
      try {
        const res = await fetch(`${API}/tts`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text, language_code: 'en' })
        });

        if (res.ok) {
          const blob = await res.blob();
          const audioUrl = URL.createObjectURL(blob);
          const audio = new Audio(audioUrl);
          currentSpeech = audio;

          audio.onplay = () => {
            speakingIndicator.classList.add('active');
          };

          audio.onended = () => {
            speakingIndicator.classList.remove('active');
            currentSpeech = null;
            URL.revokeObjectURL(audioUrl);
          };

          audio.onerror = () => {
            speakingIndicator.classList.remove('active');
            currentSpeech = null;
          };

          audio.play().catch(err => {
            console.error('Audio play error:', err);
            speakingIndicator.classList.remove('active');
          });
        }
      } catch (e) {
        console.error('TTS error:', e);
        speakingIndicator.classList.remove('active');
      }
    };

    // Toggle chatbot
    toggler.onclick = () => document.body.classList.toggle('show-chatbot');
    closeBtn.onclick = () => document.body.classList.remove('show-chatbot');

    // Load chat history
    const loadChatHistory = async (uid) => {
      try {
        const res = await fetch(`${API}/chat-history/${encodeURIComponent(uid)}`);
        if (!res.ok) return [];
        const data = await res.json();
        return data.chat_history || [];
      } catch (e) {
        console.error('Failed to load chat history:', e);
        return [];
      }
    };

    // Delete chat history
    const deleteChatHistory = async (uid) => {
      try {
        await fetch(`${API}/chat-history/${encodeURIComponent(uid)}`, { method: 'DELETE' });
      } catch (e) {
        console.error('Failed to delete chat history:', e);
      }
    };

    // Load patient summary
    const loadPatientSummary = async (uid) => {
      try {
        const res = await fetch(`${API}/patient-summary/${encodeURIComponent(uid)}`);
        if (!res.ok) return null;
        const data = await res.json();
        return data.summary || null;
      } catch (e) {
        console.error('Failed to load patient summary:', e);
        return null;
      }
    };

    // Update user info bar
    const updateUserBar = () => {
      const msgCount = chatHistory.length;
      let html = `<span class="material-symbols-outlined" style="font-size:18px">person</span>`;
      html += userName || 'Guest';

      if (msgCount > 0) {
        html += ` <span class="badge">${msgCount} messages</span>`;
      }

      userBar.innerHTML = html;
    };

    // Initialize chat
    const initChat = async (isReturning = false) => {
      updateUserBar();
      chatbox.innerHTML = '';

      if (chatHistory.length > 0) {
        chatHistory.forEach(msg => {
          if (msg.content?.trim()) {
            addMessage(msg.content, msg.role === 'user' ? 'outgoing' : 'incoming');
          }
        });
      }
    };

    // Show patient summary
    summaryBtn.onclick = async () => {
      if (!userId) {
        alert('Please login first');
        return;
      }

      const summary = await loadPatientSummary(userId);
      if (summary && summary !== "No patient data available") {
        addMessage(summary, 'incoming');
      } else {
        addMessage("ðŸ“‹ No previous medical records found for your account.", 'incoming');
      }
    };

    // Modal handler
    startBtn.onclick = async () => {
      const name = nameInput.value.trim();
      if (!name) {
        alert('Please enter your name');
        return;
      }

      startBtn.textContent = 'Loading...';
      startBtn.disabled = true;

      userId = name.toLowerCase().replace(/\s+/g, '_');
      userName = name;

      const history = await loadChatHistory(userId);

      if (history && history.length > 0) {
        const loadPrevious = confirm(
          `Welcome back ${userName}! You have ${history.length} messages in your previous conversation.\n\n` +
          `Click OK to continue from where you left off, or Cancel to start a fresh conversation.`
        );

        if (loadPrevious) {
          chatHistory = history;
          await initChat(true);
          modal.classList.add('hidden');

          localStorage.setItem('healbot_user_id', userId);
          localStorage.setItem('healbot_user_name', userName);

          startBtn.textContent = 'Start Consultation';
          startBtn.disabled = false;
          return;
        } else {
          await deleteChatHistory(userId);
        }
      }

      chatHistory = [];
      await initChat(false);
      modal.classList.add('hidden');

      localStorage.setItem('healbot_user_id', userId);
      localStorage.setItem('healbot_user_name', userName);

      startBtn.textContent = 'Start Consultation';
      startBtn.disabled = false;
    };

    // New session
    newSessionBtn.onclick = async () => {
      const choice = confirm(
        'Start a new session?\n\n' +
        'Click OK to clear your current chat and start fresh, or Cancel to continue.'
      );

      if (choice) {
        stopSpeaking(); // Stop any speech
        if (userId) await deleteChatHistory(userId);

        userId = null;
        userName = null;
        chatHistory = [];
        chatbox.innerHTML = '';
        nameInput.value = '';

        localStorage.removeItem('healbot_user_id');
        localStorage.removeItem('healbot_user_name');

        modal.classList.remove('hidden');
      }
    };

    // Add message to UI
    const addMessage = (text, type, isThinking = false) => {
      const li = document.createElement('li');
      li.className = `chat ${type}`;

      if (type === 'incoming') {
        li.innerHTML = `<span class="bot-icon material-symbols-outlined">smart_toy</span><p>${isThinking ? 'Thinking...' : ''}</p>`;
      } else {
        li.innerHTML = `<p></p>`;
      }

      const p = li.querySelector('p');
      if (!isThinking) p.textContent = text;
      if (isThinking) p.classList.add('thinking');

      chatbox.appendChild(li);
      chatbox.scrollTop = chatbox.scrollHeight;
      return p;
    };

    // Send message
    const sendMessage = async (msg) => {
      try {
        const res = await fetch(`${API}/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: msg,
            user_id: userId,
            language: "auto"
          })
        });

        if (!res.ok) {
          const errorData = await res.json();
          throw new Error(errorData.detail || `Server error: ${res.status}`);
        }

        return await res.json();
      } catch (e) {
        console.error('Send error:', e);
        throw e;
      }
    };

    // Handle send
    const handleSend = async () => {
      const msg = input.value.trim();
      if (!msg) return;

      stopSpeaking(); // Stop any current speech when sending new message

      input.value = '';
      addMessage(msg, 'outgoing');

      chatHistory.push({ role: 'user', content: msg });

      const thinkingP = addMessage('', 'incoming', true);

      try {
        const data = await sendMessage(msg);
        thinkingP.textContent = data.reply;
        thinkingP.classList.remove('thinking');

        chatHistory.push({ role: 'assistant', content: data.reply });
        updateUserBar();

        // Speak the response
        speak(data.reply);
      } catch (e) {
        thinkingP.textContent = 'Error: ' + e.message;
        thinkingP.classList.add('error');
        thinkingP.classList.remove('thinking');
        chatHistory.pop();
      }
    };

    sendBtn.onclick = handleSend;
    input.onkeydown = (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    };

    // Stop speech when user starts typing
    input.oninput = () => {
      if (input.value.length > 0) {
        stopSpeaking();
      }
    };

    // Stop speech when clicking anywhere in chatbox
    chatbox.onclick = stopSpeaking;

    // Voice recording with Web Speech API
    voiceBtn.onclick = async () => {
      if (recording) {
        if (recognition) {
          recognition.stop();
        }
        recording = false;
        voiceBtn.classList.remove('recording');
        return;
      }

      stopSpeaking(); // Stop any speech before recording

      // Try Web Speech API first
      if (recognition) {
        try {
          recognition.start();
          recording = true;
          voiceBtn.classList.add('recording');
          return;
        } catch (e) {
          console.error('Speech recognition start error:', e);
        }
      }

      // Fallback to MediaRecorder (server STT)
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        const chunks = [];

        mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
        mediaRecorder.onstop = async () => {
          recording = false;
          voiceBtn.classList.remove('recording');
          stream.getTracks().forEach(t => t.stop());

          const blob = new Blob(chunks, { type: 'audio/wav' });
          const form = new FormData();
          form.append('file', blob, 'audio.wav');

          try {
            const res = await fetch(`${API}/stt`, { method: 'POST', body: form });
            const data = await res.json();
            if (data.transcript) {
              input.value = data.transcript;
              setTimeout(() => handleSend(), 300);
            }
          } catch (e) {
            console.error('STT error:', e);
            alert('Speech recognition failed. Please try again.');
          }
        };

        mediaRecorder.start();
        recording = true;
        voiceBtn.classList.add('recording');
      } catch (e) {
        alert('Microphone access denied or not available');
      }
    };

    // Initialize
    (async () => {
      initSpeechRecognition();

      const savedUserId = localStorage.getItem('healbot_user_id');
      const savedUserName = localStorage.getItem('healbot_user_name');

      if (savedUserId && savedUserName) {
        userId = savedUserId;
        userName = savedUserName;

        const history = await loadChatHistory(userId);

        if (history && history.length > 0) {
          chatHistory = history;
          await initChat(true);
          modal.classList.add('hidden');
          return;
        }
      }

      modal.classList.remove('hidden');
    })();
  </script>
</body>

</html>